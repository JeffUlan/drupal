<?php

/**
 * Implements hook_theme().
 */
function views_dropbutton_theme($existing, $type, $theme, $path) {
  return array(
    'dropbutton_wrapper' => array(
      'render element' => 'element',
    ),
  );
}

/**
 * Implements hook_library_info().
 */
function views_dropbutton_library_info() {
  $path = drupal_get_path('module', 'views_dropbutton');
  $libraries['drupal.dropbutton'] = array(
    'title' => 'Dropbutton',
    'website' => 'http://drupal.org/node/1608878',
    'version' => '1.0',
    'js' => array(
      "$path/dropbutton.js" => array(),
    ),
    'css' => array(
      "$path/dropbutton.base.css" => array(),
      "$path/dropbutton.theme.css" => array(),
    ),
    'dependencies' => array(
      array('system', 'jquery'),
      array('system', 'drupal'),
      array('system', 'drupalSettings'),
      array('system', 'jquery.once'),
    ),
  );

  return $libraries;
}

/**
 * Implements hook_element_info().
 */
function views_dropbutton_element_info() {
  $types['dropbutton'] = array(
    '#theme' => 'links__dropbutton',
    '#pre_render' => array('drupal_pre_render_dropbutton'),
  );
  return $types;
}

/**
 * Pre-render callback: Attaches the dropbutton library and required markup.
 */
function drupal_pre_render_dropbutton($element) {
  $element['#attached']['library'][] = array('views_dropbutton', 'drupal.dropbutton');
  $element['#attributes']['class'][] = 'dropbutton';
  if (!isset($element['#theme_wrappers'])) {
    $element['#theme_wrappers'] = array();
  }
  array_unshift($element['#theme_wrappers'], 'dropbutton_wrapper');

  // Enable targeted theming of specific dropbuttons (e.g., 'operations' or
  // 'operations__node').
  if (isset($element['#subtype'])) {
    $element['#theme'] .= '__' . $element['#subtype'];
  }

  return $element;
}

/**
 * Returns HTML for wrapping a dropbutton menu.
 *
 * @param array $variables
 *   An associative array containing:
 *   - element: An associative array containing the properties and children of
 *     the dropbutton menu. Properties used: #children.
 */
function theme_dropbutton_wrapper($variables) {
  return '<div class="dropbutton-wrapper"><div class="dropbutton-widget">' . $variables['element']['#children'] . '</div></div>';
}
